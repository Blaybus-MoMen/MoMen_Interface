#!/bin/bash

# ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# docker-compose ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸš€ Momen ì›ê²© ì„œë²„ ë°°í¬"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# â”€â”€ Docker ì ‘ê·¼ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ”§ Docker ë°ëª¬ ì ‘ê·¼ í™•ì¸..."
docker info >/dev/null 2>&1 || { echo "âŒ Docker ì ‘ê·¼ ì‹¤íŒ¨"; exit 1; }
echo "âœ… Docker ì ‘ê·¼ ê°€ëŠ¥"

# â”€â”€ ì´ë¯¸ì§€ ë¡œë“œ (tar íŒŒì¼ì´ ìžˆëŠ” ê²½ìš°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "momen-image.tar" ]; then
    echo ""
    echo "ðŸ“¦ Docker ì´ë¯¸ì§€ ë¡œë“œ ì¤‘..."
    docker load -i momen-image.tar
    rm -f momen-image.tar
    echo "âœ… ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ"
fi

# â”€â”€ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "momen.env" ] && [ ! -f ".env" ]; then
    cp momen.env .env
    echo "ðŸ“‹ momen.env â†’ .env ë³µì‚¬"
fi

if [ ! -f ".env" ]; then
    echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
    exit 1
fi

# â”€â”€ docker-compose.yml í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ ! -f "docker-compose.yml" ]; then
    echo "âŒ docker-compose.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
    exit 1
fi

# â”€â”€ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° docker-compose ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
docker-compose down 2>/dev/null || true

# ì´ë¦„ ì¶©ëŒ ë°©ì§€
docker stop momen momen-api momen-redis 2>/dev/null || true
docker rm momen momen-api momen-redis 2>/dev/null || true

echo ""
echo "ðŸš€ Docker Compose ì‹¤í–‰ ì¤‘..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose up -d

# â”€â”€ ë°°í¬ ê²°ê³¼ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š ë°°í¬ ê²°ê³¼ í™•ì¸"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "ðŸ“¦ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
docker-compose ps

echo ""
echo "ðŸ“‹ ì•± ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 30ì¤„):"
docker-compose logs --tail=30 app 2>&1

# í—¬ìŠ¤ ì²´í¬
echo ""
echo "ðŸ¥ í—¬ìŠ¤ ì²´í¬ (30ì´ˆ ëŒ€ê¸°)..."
sleep 30

if docker ps | grep -q "momen-api"; then
    SERVER_IP=$(hostname -I | awk '{print $1}' 2>/dev/null || echo "221.148.101.200")
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜: http://$SERVER_IP:8089"
    echo "ðŸ“‹ ë¡œê·¸ í™•ì¸: docker-compose logs -f app"
    echo "ðŸ›‘ ì¤‘ì§€ ëª…ë ¹: docker-compose down"
    echo "ðŸ”„ ìž¬ì‹œìž‘ ëª…ë ¹: docker-compose restart app"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
else
    echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
    echo "ðŸ“‹ ì „ì²´ ë¡œê·¸:"
    docker-compose logs app 2>&1
    exit 1
fi
